import{u as B,a as H,r as _,j as e,H as K,L as G}from"./app-DUaT__wH.js";import{A as J}from"./AuthenticatedLayout-BRA9NZV-.js";import{T as S}from"./InfoIcon-ISLSAj6V.js";import{f as x}from"./currency-DO5TMxe2.js";import"./transition-7jmKK-Rq.js";import"./HelpInjector-BCvt9IJE.js";function ee({customers:g,products:u}){const{t:s}=B(),{data:n,setData:o,post:L,processing:D,errors:I}=H({customer_id:"",customer_name:"",customer_email:"",payment_method:"cash",amount_paid:"",discount_type:"amount",discount_value:"",note:"",items:[]}),[f,P]=_.useState(""),[v,T]=_.useState(""),A=_.useMemo(()=>{const t=f.toLowerCase();return t?g.filter(a=>a.name.toLowerCase().includes(t)):g},[g,f]),F=_.useMemo(()=>{const t=v.toLowerCase();return t?u.filter(a=>a.name&&a.name.toLowerCase().includes(t)||a.sku&&a.sku.toLowerCase().includes(t)):u},[u,v]),R=async t=>{const a=parseInt(t);if(!a)return;const r=u.find(l=>l.id===a);if(!r)return;const c=n.items.findIndex(l=>l.product_id===a);if(c>=0){const l=[...n.items],d=parseInt(l[c].quantity||1),i=Math.max(0,parseInt(r?.stock??0));l[c].quantity=Math.min(i||d+1,d+1),o("items",l)}else{let l=r.price;try{const d=await fetch(route("pricing.compute")+`?product_id=${a}`,{headers:{Accept:"application/json"}});if(d.ok){const i=await d.json();i&&typeof i.sold_price<"u"&&(l=parseFloat(i.sold_price))}}catch{}o("items",[...n.items,{product_id:r.id,quantity:1,unit_price:l}])}},U=(t,a)=>{const r=Math.max(1,parseInt(a||1)),c=[...n.items],l=u.find(i=>i.id===c[t].product_id),d=Math.max(0,parseInt(l?.stock??0));c[t].quantity=d>0?Math.min(d,r):r,o("items",c)},E=(t,a)=>{const r=Math.max(0,parseFloat(a||0)),c=[...n.items];c[t].unit_price=r,o("items",c)},Q=t=>{const a=[...n.items];a.splice(t,1),o("items",a)},m=_.useMemo(()=>{const t=n.items.reduce((N,p)=>{const w=u.find(q=>q.id===p.product_id),k=parseFloat(p.unit_price??w?.price??0),C=parseInt(p.quantity??0),M=p.line_total!=null?Number(p.line_total||0):k*C;return N+M},0),a=parseFloat(n.discount_value||0);let r=0;n.discount_type==="percent"?r=Math.min(100,Math.max(0,a))*t/100:r=Math.min(t,Math.max(0,a));const c=Math.max(0,t-r);let l=0;const i=c/(t||1);n.items.forEach(N=>{const p=u.find(q=>q.id===N.product_id),w=parseFloat(N.unit_price??p?.price??0),k=parseInt(N.quantity??0),C=w*k*i,M=parseFloat(p?.tax_rate??0)/100;l+=C*M}),l=Math.round(l*100)/100;const j=Math.round((c+l)*100)/100,h=n.amount_paid!==""&&!isNaN(parseFloat(n.amount_paid)),b=h?Math.min(j,Math.max(0,parseFloat(n.amount_paid))):0,y=Math.max(0,Math.round((j-b)*100)/100),$=h?y<=0?"paid":b>0?"partial":"credit":"credit";return{subtotal:t,headerDiscount:r,tax:l,grand:j,paid:b,balance:y,status:$}},[n.items,n.discount_type,n.discount_value,n.amount_paid,u]),W=t=>{t.preventDefault(),L(route("sales.store"))};return e.jsxs(J,{header:e.jsx("h2",{className:"text-xl font-semibold",children:s("new_sale")||"New Sale"}),children:[e.jsx(K,{title:s("new_sale")||"New Sale"}),e.jsx("div",{className:"mx-auto max-w-4xl p-6",children:e.jsxs("form",{onSubmit:W,className:"space-y-6 bg-white p-6 shadow rounded",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:s("customer_label")}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:s("search_customer")||"Search customer",value:f,onChange:t=>P(t.target.value)}),e.jsxs("select",{className:"mt-2 w-full rounded border p-2",value:n.customer_id,onChange:t=>o("customer_id",t.target.value),children:[e.jsx("option",{value:"",children:s("walk_in")}),A.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-2",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s("create_new_customer_hint")||"Or create a new customer (name and unique email):"}),e.jsx("input",{className:"w-full rounded border p-2",placeholder:s("new_customer_name")||"New customer name",value:n.customer_name,onChange:t=>o("customer_name",t.target.value)}),e.jsx("input",{type:"email",className:"w-full rounded border p-2",placeholder:s("new_customer_email")||"New customer email",value:n.customer_email,onChange:t=>o("customer_email",t.target.value)}),e.jsx("div",{className:"text-xs text-gray-500",children:s("auto_create_customer_note")||"If you leave the dropdown empty and provide these fields, we will auto-create and link this customer on save."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:s("payment_method")}),e.jsxs("select",{className:"mt-1 w-full rounded border p-2",value:n.payment_method,onChange:t=>o("payment_method",t.target.value),children:[e.jsx("option",{value:"cash",children:s("cash")}),e.jsx("option",{value:"card",children:s("card")||"Card"}),e.jsx("option",{value:"bank",children:s("bank")||"Bank"}),e.jsx("option",{value:"mobile",children:s("mobile")||"Mobile"}),e.jsx("option",{value:"wallet",children:s("wallet")||"Wallet"}),e.jsx("option",{value:"credit",children:s("credit")||"Credit"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:s("amount_paid")}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"mt-1 w-full rounded border p-2",value:n.amount_paid,onChange:t=>o("amount_paid",t.target.value)}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:[s("status_label"),": ",e.jsx("span",{className:`px-2 py-0.5 rounded ${m.status==="paid"?"bg-green-100 text-green-700":m.status==="partial"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:s(m.status)||m.status})]})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium",children:s("note_label_optional")||"Note / Label (optional)"}),e.jsx("input",{type:"text",maxLength:255,className:"mt-1 w-full rounded border p-2",placeholder:s("note_placeholder")||"e.g., John Doe (Walk-in), Table 7, Urgent delivery, etc.",value:n.note,onChange:t=>o("note",t.target.value)}),e.jsx("div",{className:"mt-1 text-xs text-gray-500",children:s("note_help")||"This note will appear on Walk-in analytics and the ledger."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:[s("add_products")," ",e.jsx(S,{text:s("search_and_add_items_tip")||"Search and add items. Quantity cannot exceed available stock.",children:"i"})]}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:s("search_by_name_or_sku")||"Search by name or SKU",value:v,onChange:t=>T(t.target.value)}),e.jsxs("div",{className:"mt-2 max-h-40 overflow-y-auto border rounded",children:[F.slice(0,100).map(t=>e.jsxs("button",{type:"button",onClick:()=>R(t.id),className:"w-full text-left px-3 py-2 hover:bg-gray-50 flex justify-between",children:[e.jsxs("span",{children:[t.name," (",t.sku,")"]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[x(Number(t.price))," Â· Stock: ",t.stock??0]})]},t.id)),F.length===0&&e.jsx("div",{className:"p-3 text-sm text-gray-500",children:s("no_products")||"No products"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:s("discount")||"Discount"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsxs("select",{className:"rounded border p-2",value:n.discount_type,onChange:t=>o("discount_type",t.target.value),children:[e.jsx("option",{value:"amount",children:s("amount")}),e.jsx("option",{value:"percent",children:s("percent")||"Percent"})]}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"flex-1 rounded border p-2",value:n.discount_value,onChange:t=>o("discount_value",t.target.value)})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:[s("calculated")||"Calculated",": ",m.headerDiscount.toFixed(2)]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left",children:s("product")}),e.jsxs("th",{className:"px-2 py-2 text-right",children:[s("unit_price")," ",e.jsx(S,{text:s("prefilled_pricing_rules_tip")||"Prefilled from pricing rules; can be overridden.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2 text-right",children:s("qty")}),e.jsx("th",{className:"px-2 py-2 text-right",children:s("available")}),e.jsx("th",{className:"px-2 py-2 text-right",children:s("line_subtotal")||s("subtotal")}),e.jsxs("th",{className:"px-2 py-2 text-right",children:[s("line_total")," ",e.jsx(S,{text:s("line_total_edit_tip")||"You can edit this; Unit Price will be recalculated as Line Total / Qty.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2"})]})}),e.jsx("tbody",{children:n.items.map((t,a)=>{const r=u.find(i=>i.id===t.product_id),c=parseFloat(t.unit_price??r?.price??0),l=parseInt(t.quantity??0),d=t.line_total!=null?Number(t.line_total||0):c*l;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-2",children:r?.name}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:0,step:"0.01",className:"w-28 rounded border p-2 text-right",value:t.unit_price??"",onChange:i=>E(a,i.target.value)})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:1,max:Math.max(1,r?.stock??1),className:"w-24 rounded border p-2 text-right",value:t.quantity,onChange:i=>U(a,i.target.value),title:`Max ${r?.stock??0} available`})}),e.jsx("td",{className:"px-2 py-2 text-right",children:r?.stock??0}),e.jsx("td",{className:"px-2 py-2 text-right",children:x(c*l)}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:0,step:"0.01",className:"w-32 rounded border p-2 text-right",value:Number(d||0),onChange:i=>{const j=Number(i.target.value||0),h=[...n.items],b=Number(h[a].quantity||0)||1,y=Number((j/b).toFixed(2));h[a]={...h[a],line_total:j,unit_price:y},o("items",h)}})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>Q(a),className:"text-red-600",children:"Remove"})})]},a)})})]})}),I.items&&e.jsx("div",{className:"text-sm text-red-600",children:I.items}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"bg-gray-50 rounded p-4",children:[e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("subtotal")}),e.jsx("span",{className:"font-medium",children:x(m.subtotal)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("discount")||"Discount"}),e.jsxs("span",{className:"font-medium",children:["-",x(m.headerDiscount)]})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("tax")}),e.jsx("span",{className:"font-medium",children:x(m.tax)})]}),e.jsxs("div",{className:"flex justify-between py-2 border-t mt-2",children:[e.jsx("span",{className:"font-medium",children:s("grand_total")||"Grand Total"}),e.jsx("span",{className:"font-bold",children:x(m.grand)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("paid")}),e.jsx("span",{className:"font-medium",children:x(m.paid)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:s("balance")}),e.jsx("span",{className:"font-medium",children:x(m.balance)})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(G,{href:route("sales.index"),className:"rounded border px-4 py-2",children:s("cancel")}),e.jsx("button",{disabled:D,className:"rounded bg-blue-600 px-4 py-2 text-white",children:s("checkout")})]})]})})]})}export{ee as default};
