import{u as H,r as h,j as e,H as K,L as U}from"./app-BPLSlo03.js";import{A as W}from"./AuthenticatedLayout-Cq5jCDel.js";import{T as q}from"./Tooltip-C55n0Qkv.js";import{f as u}from"./currency-DO5TMxe2.js";import"./transition-wZ_MSpzK.js";function X({customers:j,products:o}){const{data:a,setData:c,post:P,processing:F,errors:C}=H({customer_id:"",payment_method:"cash",amount_paid:"",discount_type:"amount",discount_value:"",items:[]}),[f,I]=h.useState(""),[y,A]=h.useState(""),D=h.useMemo(()=>{const t=f.toLowerCase();return t?j.filter(s=>s.name.toLowerCase().includes(t)):j},[j,f]),k=h.useMemo(()=>{const t=y.toLowerCase();return t?o.filter(s=>s.name&&s.name.toLowerCase().includes(t)||s.sku&&s.sku.toLowerCase().includes(t)):o},[o,y]),L=async t=>{const s=parseInt(t);if(!s)return;const n=o.find(i=>i.id===s);if(!n)return;const l=a.items.findIndex(i=>i.product_id===s);if(l>=0){const i=[...a.items],r=parseInt(i[l].quantity||1),m=Math.max(0,parseInt(n?.stock??0));i[l].quantity=Math.min(m||r+1,r+1),c("items",i)}else{let i=n.price;try{const r=await fetch(route("pricing.compute")+`?product_id=${s}`,{headers:{Accept:"application/json"}});if(r.ok){const m=await r.json();m&&typeof m.sold_price<"u"&&(i=parseFloat(m.sold_price))}}catch{}c("items",[...a.items,{product_id:n.id,quantity:1,unit_price:i}])}},R=(t,s)=>{const n=Math.max(1,parseInt(s||1)),l=[...a.items],i=o.find(m=>m.id===l[t].product_id),r=Math.max(0,parseInt(i?.stock??0));l[t].quantity=r>0?Math.min(r,n):n,c("items",l)},T=(t,s)=>{const n=Math.max(0,parseFloat(s||0)),l=[...a.items];l[t].unit_price=n,c("items",l)},B=t=>{const s=[...a.items];s.splice(t,1),c("items",s)},d=h.useMemo(()=>{const t=a.items.reduce((p,x)=>{const g=o.find(w=>w.id===x.product_id),v=parseFloat(x.unit_price??g?.price??0),_=parseInt(x.quantity??0);return p+v*_},0),s=parseFloat(a.discount_value||0);let n=0;a.discount_type==="percent"?n=Math.min(100,Math.max(0,s))*t/100:n=Math.min(t,Math.max(0,s));const l=Math.max(0,t-n);let i=0;const m=l/(t||1);a.items.forEach(p=>{const x=o.find($=>$.id===p.product_id),g=parseFloat(p.unit_price??x?.price??0),v=parseInt(p.quantity??0),_=g*v*m,w=parseFloat(x?.tax_rate??0)/100;i+=_*w}),i=Math.round(i*100)/100;const N=Math.round((l+i)*100)/100,M=a.amount_paid!==""&&!isNaN(parseFloat(a.amount_paid)),b=M?Math.min(N,Math.max(0,parseFloat(a.amount_paid))):0,S=Math.max(0,Math.round((N-b)*100)/100),Q=M?S<=0?"paid":b>0?"partial":"credit":"credit";return{subtotal:t,headerDiscount:n,tax:i,grand:N,paid:b,balance:S,status:Q}},[a.items,a.discount_type,a.discount_value,a.amount_paid,o]),E=t=>{t.preventDefault(),P(route("sales.store"))};return e.jsxs(W,{header:e.jsx("h2",{className:"text-xl font-semibold",children:"New Sale"}),children:[e.jsx(K,{title:"New Sale"}),e.jsx("div",{className:"mx-auto max-w-4xl p-6",children:e.jsxs("form",{onSubmit:E,className:"space-y-6 bg-white p-6 shadow rounded",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Customer"}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:"Search customer",value:f,onChange:t=>I(t.target.value)}),e.jsxs("select",{className:"mt-2 w-full rounded border p-2",value:a.customer_id,onChange:t=>c("customer_id",t.target.value),children:[e.jsx("option",{value:"",children:"Walk-in"}),D.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Payment Method"}),e.jsxs("select",{className:"mt-1 w-full rounded border p-2",value:a.payment_method,onChange:t=>c("payment_method",t.target.value),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"bank",children:"Bank"}),e.jsx("option",{value:"mobile",children:"Mobile"}),e.jsx("option",{value:"wallet",children:"Wallet"}),e.jsx("option",{value:"credit",children:"Credit"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Amount Paid"}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"mt-1 w-full rounded border p-2",value:a.amount_paid,onChange:t=>c("amount_paid",t.target.value)}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Status: ",e.jsx("span",{className:`px-2 py-0.5 rounded ${d.status==="paid"?"bg-green-100 text-green-700":d.status==="partial"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:d.status})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["Add Products ",e.jsx(q,{text:"Search and add items. Quantity cannot exceed available stock.",children:"i"})]}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:"Search by name or SKU",value:y,onChange:t=>A(t.target.value)}),e.jsxs("div",{className:"mt-2 max-h-40 overflow-y-auto border rounded",children:[k.slice(0,100).map(t=>e.jsxs("button",{type:"button",onClick:()=>L(t.id),className:"w-full text-left px-3 py-2 hover:bg-gray-50 flex justify-between",children:[e.jsxs("span",{children:[t.name," (",t.sku,")"]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[u(Number(t.price))," Â· Stock: ",t.stock??0]})]},t.id)),k.length===0&&e.jsx("div",{className:"p-3 text-sm text-gray-500",children:"No products"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Discount"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsxs("select",{className:"rounded border p-2",value:a.discount_type,onChange:t=>c("discount_type",t.target.value),children:[e.jsx("option",{value:"amount",children:"Amount"}),e.jsx("option",{value:"percent",children:"Percent"})]}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"flex-1 rounded border p-2",value:a.discount_value,onChange:t=>c("discount_value",t.target.value)})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Calculated: ",d.headerDiscount.toFixed(2)]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left",children:"Product"}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Unit Price ",e.jsx(q,{text:"Prefilled from pricing rules; can be overridden.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Qty"}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Available"}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Line Subtotal"}),e.jsx("th",{className:"px-2 py-2"})]})}),e.jsx("tbody",{children:a.items.map((t,s)=>{const n=o.find(r=>r.id===t.product_id),l=parseFloat(t.unit_price??n?.price??0),i=parseInt(t.quantity??0);return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-2",children:n?.name}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:0,step:"0.01",className:"w-28 rounded border p-2 text-right",value:t.unit_price??"",onChange:r=>T(s,r.target.value)})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:1,max:Math.max(1,n?.stock??1),className:"w-24 rounded border p-2 text-right",value:t.quantity,onChange:r=>R(s,r.target.value),title:`Max ${n?.stock??0} available`})}),e.jsx("td",{className:"px-2 py-2 text-right",children:n?.stock??0}),e.jsx("td",{className:"px-2 py-2 text-right",children:u(l*i)}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>B(s),className:"text-red-600",children:"Remove"})})]},s)})})]})}),C.items&&e.jsx("div",{className:"text-sm text-red-600",children:C.items}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"bg-gray-50 rounded p-4",children:[e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:u(d.subtotal)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Discount"}),e.jsxs("span",{className:"font-medium",children:["-",u(d.headerDiscount)]})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Tax"}),e.jsx("span",{className:"font-medium",children:u(d.tax)})]}),e.jsxs("div",{className:"flex justify-between py-2 border-t mt-2",children:[e.jsx("span",{className:"font-medium",children:"Grand Total"}),e.jsx("span",{className:"font-bold",children:u(d.grand)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Paid"}),e.jsx("span",{className:"font-medium",children:u(d.paid)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Balance"}),e.jsx("span",{className:"font-medium",children:u(d.balance)})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(U,{href:route("sales.index"),className:"rounded border px-4 py-2",children:"Cancel"}),e.jsx("button",{disabled:F,className:"rounded bg-blue-600 px-4 py-2 text-white",children:"Checkout"})]})]})})]})}export{X as default};
