import{u as E,r as y,j as e,H as $,L as H}from"./app-BHEhQ5cj.js";import{A as K}from"./AuthenticatedLayout-DgtMcvBc.js";import{T as S}from"./Tooltip-Ul3oOJD-.js";import{f as x}from"./currency-DO5TMxe2.js";import"./transition-cX6JQt8z.js";function z({customers:g,products:m}){const{data:a,setData:c,post:P,processing:F,errors:q}=E({customer_id:"",customer_name:"",customer_email:"",payment_method:"cash",amount_paid:"",discount_type:"amount",discount_value:"",note:"",items:[]}),[f,I]=y.useState(""),[v,D]=y.useState(""),A=y.useMemo(()=>{const t=f.toLowerCase();return t?g.filter(s=>s.name.toLowerCase().includes(t)):g},[g,f]),L=y.useMemo(()=>{const t=v.toLowerCase();return t?m.filter(s=>s.name&&s.name.toLowerCase().includes(t)||s.sku&&s.sku.toLowerCase().includes(t)):m},[m,v]),T=async t=>{const s=parseInt(t);if(!s)return;const l=m.find(n=>n.id===s);if(!l)return;const r=a.items.findIndex(n=>n.product_id===s);if(r>=0){const n=[...a.items],o=parseInt(n[r].quantity||1),i=Math.max(0,parseInt(l?.stock??0));n[r].quantity=Math.min(i||o+1,o+1),c("items",n)}else{let n=l.price;try{const o=await fetch(route("pricing.compute")+`?product_id=${s}`,{headers:{Accept:"application/json"}});if(o.ok){const i=await o.json();i&&typeof i.sold_price<"u"&&(n=parseFloat(i.sold_price))}}catch{}c("items",[...a.items,{product_id:l.id,quantity:1,unit_price:n}])}},U=(t,s)=>{const l=Math.max(1,parseInt(s||1)),r=[...a.items],n=m.find(i=>i.id===r[t].product_id),o=Math.max(0,parseInt(n?.stock??0));r[t].quantity=o>0?Math.min(o,l):l,c("items",r)},Q=(t,s)=>{const l=Math.max(0,parseFloat(s||0)),r=[...a.items];r[t].unit_price=l,c("items",r)},R=t=>{const s=[...a.items];s.splice(t,1),c("items",s)},d=y.useMemo(()=>{const t=a.items.reduce((N,u)=>{const _=m.find(M=>M.id===u.product_id),w=parseFloat(u.unit_price??_?.price??0),C=parseInt(u.quantity??0),k=u.line_total!=null?Number(u.line_total||0):w*C;return N+k},0),s=parseFloat(a.discount_value||0);let l=0;a.discount_type==="percent"?l=Math.min(100,Math.max(0,s))*t/100:l=Math.min(t,Math.max(0,s));const r=Math.max(0,t-l);let n=0;const i=r/(t||1);a.items.forEach(N=>{const u=m.find(M=>M.id===N.product_id),_=parseFloat(N.unit_price??u?.price??0),w=parseInt(N.quantity??0),C=_*w*i,k=parseFloat(u?.tax_rate??0)/100;n+=C*k}),n=Math.round(n*100)/100;const h=Math.round((r+n)*100)/100,p=a.amount_paid!==""&&!isNaN(parseFloat(a.amount_paid)),j=p?Math.min(h,Math.max(0,parseFloat(a.amount_paid))):0,b=Math.max(0,Math.round((h-j)*100)/100),B=p?b<=0?"paid":j>0?"partial":"credit":"credit";return{subtotal:t,headerDiscount:l,tax:n,grand:h,paid:j,balance:b,status:B}},[a.items,a.discount_type,a.discount_value,a.amount_paid,m]),W=t=>{t.preventDefault(),P(route("sales.store"))};return e.jsxs(K,{header:e.jsx("h2",{className:"text-xl font-semibold",children:"New Sale"}),children:[e.jsx($,{title:"New Sale"}),e.jsx("div",{className:"mx-auto max-w-4xl p-6",children:e.jsxs("form",{onSubmit:W,className:"space-y-6 bg-white p-6 shadow rounded",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Customer"}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:"Search customer",value:f,onChange:t=>I(t.target.value)}),e.jsxs("select",{className:"mt-2 w-full rounded border p-2",value:a.customer_id,onChange:t=>c("customer_id",t.target.value),children:[e.jsx("option",{value:"",children:"Walk-in"}),A.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-2",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"Or create a new customer (name and unique email):"}),e.jsx("input",{className:"w-full rounded border p-2",placeholder:"New customer name",value:a.customer_name,onChange:t=>c("customer_name",t.target.value)}),e.jsx("input",{type:"email",className:"w-full rounded border p-2",placeholder:"New customer email",value:a.customer_email,onChange:t=>c("customer_email",t.target.value)}),e.jsx("div",{className:"text-xs text-gray-500",children:"If you leave the dropdown empty and provide these fields, we will auto-create and link this customer on save."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Payment Method"}),e.jsxs("select",{className:"mt-1 w-full rounded border p-2",value:a.payment_method,onChange:t=>c("payment_method",t.target.value),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"bank",children:"Bank"}),e.jsx("option",{value:"mobile",children:"Mobile"}),e.jsx("option",{value:"wallet",children:"Wallet"}),e.jsx("option",{value:"credit",children:"Credit"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Amount Paid"}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"mt-1 w-full rounded border p-2",value:a.amount_paid,onChange:t=>c("amount_paid",t.target.value)}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Status: ",e.jsx("span",{className:`px-2 py-0.5 rounded ${d.status==="paid"?"bg-green-100 text-green-700":d.status==="partial"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:d.status})]})]}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Note / Label (optional)"}),e.jsx("input",{type:"text",maxLength:255,className:"mt-1 w-full rounded border p-2",placeholder:"e.g., John Doe (Walk-in), Table 7, Urgent delivery, etc.",value:a.note,onChange:t=>c("note",t.target.value)}),e.jsx("div",{className:"mt-1 text-xs text-gray-500",children:"This note will appear on Walk-in analytics and the ledger."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["Add Products ",e.jsx(S,{text:"Search and add items. Quantity cannot exceed available stock.",children:"i"})]}),e.jsx("input",{className:"mt-1 w-full rounded border p-2",placeholder:"Search by name or SKU",value:v,onChange:t=>D(t.target.value)}),e.jsxs("div",{className:"mt-2 max-h-40 overflow-y-auto border rounded",children:[L.slice(0,100).map(t=>e.jsxs("button",{type:"button",onClick:()=>T(t.id),className:"w-full text-left px-3 py-2 hover:bg-gray-50 flex justify-between",children:[e.jsxs("span",{children:[t.name," (",t.sku,")"]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[x(Number(t.price))," Â· Stock: ",t.stock??0]})]},t.id)),L.length===0&&e.jsx("div",{className:"p-3 text-sm text-gray-500",children:"No products"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Discount"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsxs("select",{className:"rounded border p-2",value:a.discount_type,onChange:t=>c("discount_type",t.target.value),children:[e.jsx("option",{value:"amount",children:"Amount"}),e.jsx("option",{value:"percent",children:"Percent"})]}),e.jsx("input",{type:"number",min:0,step:"0.01",className:"flex-1 rounded border p-2",value:a.discount_value,onChange:t=>c("discount_value",t.target.value)})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Calculated: ",d.headerDiscount.toFixed(2)]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left",children:"Product"}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Unit Price ",e.jsx(S,{text:"Prefilled from pricing rules; can be overridden.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Qty"}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Available"}),e.jsx("th",{className:"px-2 py-2 text-right",children:"Line Subtotal"}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Line Total ",e.jsx(S,{text:"You can edit this; Unit Price will be recalculated as Line Total / Qty.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2"})]})}),e.jsx("tbody",{children:a.items.map((t,s)=>{const l=m.find(i=>i.id===t.product_id),r=parseFloat(t.unit_price??l?.price??0),n=parseInt(t.quantity??0),o=t.line_total!=null?Number(t.line_total||0):r*n;return e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-2",children:l?.name}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:0,step:"0.01",className:"w-28 rounded border p-2 text-right",value:t.unit_price??"",onChange:i=>Q(s,i.target.value)})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:1,max:Math.max(1,l?.stock??1),className:"w-24 rounded border p-2 text-right",value:t.quantity,onChange:i=>U(s,i.target.value),title:`Max ${l?.stock??0} available`})}),e.jsx("td",{className:"px-2 py-2 text-right",children:l?.stock??0}),e.jsx("td",{className:"px-2 py-2 text-right",children:x(r*n)}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("input",{type:"number",min:0,step:"0.01",className:"w-32 rounded border p-2 text-right",value:Number(o||0),onChange:i=>{const h=Number(i.target.value||0),p=[...a.items],j=Number(p[s].quantity||0)||1,b=Number((h/j).toFixed(2));p[s]={...p[s],line_total:h,unit_price:b},c("items",p)}})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>R(s),className:"text-red-600",children:"Remove"})})]},s)})})]})}),q.items&&e.jsx("div",{className:"text-sm text-red-600",children:q.items}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{}),e.jsxs("div",{className:"bg-gray-50 rounded p-4",children:[e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Subtotal"}),e.jsx("span",{className:"font-medium",children:x(d.subtotal)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Discount"}),e.jsxs("span",{className:"font-medium",children:["-",x(d.headerDiscount)]})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Tax"}),e.jsx("span",{className:"font-medium",children:x(d.tax)})]}),e.jsxs("div",{className:"flex justify-between py-2 border-t mt-2",children:[e.jsx("span",{className:"font-medium",children:"Grand Total"}),e.jsx("span",{className:"font-bold",children:x(d.grand)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Paid"}),e.jsx("span",{className:"font-medium",children:x(d.paid)})]}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Balance"}),e.jsx("span",{className:"font-medium",children:x(d.balance)})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(H,{href:route("sales.index"),className:"rounded border px-4 py-2",children:"Cancel"}),e.jsx("button",{disabled:F,className:"rounded bg-blue-600 px-4 py-2 text-white",children:"Checkout"})]})]})})]})}export{z as default};
