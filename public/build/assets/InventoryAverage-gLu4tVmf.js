import{u as L,r as w,j as e,H as U,L as P}from"./app-CtQDaI7d.js";import{A as M}from"./AuthenticatedLayout-BmdE4ikK.js";import{T as a}from"./InfoIcon-CwQLPO0h.js";import{C as h}from"./Currency-CszHn8AI.js";import"./transition-TUICTNyj.js";import"./HelpInjector-BfWS8fx6.js";function E({purchases:m=[],sales:c=[],width:d=380,height:u=70}){const n=m.map(l=>Number(l.unit_cost||0)),i=c.map(l=>Number(l.unit_price||0)),j=[...n,...i].filter(l=>typeof l=="number"&&!isNaN(l));if(!j.length)return null;const y=Math.min(...j),A=Math.max(...j)-y||1,N=Math.max(n.length,i.length),f=N>1?d/(N-1):d,p=l=>l.map((t,s)=>{const r=s*f,o=u-((t-y)/A*(u-4)+2);return`${s===0?"M":"L"} ${r.toFixed(2)} ${o.toFixed(2)}`}).join(" "),b=n.length?p(n):null,_=i.length?p(i):null;return e.jsxs("svg",{width:d,height:u,viewBox:`0 0 ${d} ${u}`,className:"w-full",children:[b&&e.jsx("path",{d:b,fill:"none",stroke:"#4f46e5",strokeWidth:"2"}),_&&e.jsx("path",{d:_,fill:"none",stroke:"#059669",strokeWidth:"2"})]})}function O({filters:m={},products:c,options:d,histories:u={}}){const{data:n,setData:i,get:j,processing:y}=L({from:m.from||"",to:m.to||"",product_id:m.product_id||"",vendor_id:m.vendor_id||""}),[C,A]=w.useState({}),[N,f]=w.useState(null),p=w.useRef(null),b=async t=>{if(!C[t])try{p.current&&p.current.abort();const s=new AbortController;p.current=s,f(t);const r=new URLSearchParams({product_id:String(t),from:n.from||"",to:n.to||"",vendor_id:n.vendor_id||""}),o=await fetch(route("reports.inventoryAverage.history")+`?${r.toString()}`,{method:"GET",headers:{Accept:"application/json"},signal:s.signal});if(!o.ok)throw new Error("Failed");const v=await o.json();A(x=>({...x,[t]:v}))}catch{}finally{f(null)}},_=t=>{t.preventDefault(),j(route("reports.inventoryAverage"))},l=w.useMemo(()=>c?.data||[],[c]);return e.jsxs(M,{header:e.jsx("h2",{className:"text-xl font-semibold leading-tight text-gray-800",children:"Inventory Average Cost"}),children:[e.jsx(U,{title:"Inventory Average Cost"}),e.jsxs("div",{className:"mx-auto max-w-7xl p-6 space-y-6",children:[e.jsxs("form",{onSubmit:_,className:"rounded bg-white p-4 shadow space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm text-gray-600 flex items-center gap-1",children:["From ",e.jsx(a,{text:"Start date to include purchases.",children:"i"})]}),e.jsx("input",{type:"date",value:n.from,onChange:t=>i("from",t.target.value),className:"w-full rounded border px-3 py-2"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm text-gray-600 flex items-center gap-1",children:["To ",e.jsx(a,{text:"End date to include purchases.",children:"i"})]}),e.jsx("input",{type:"date",value:n.to,onChange:t=>i("to",t.target.value),className:"w-full rounded border px-3 py-2"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm text-gray-600 flex items-center gap-1",children:["Product ",e.jsx(a,{text:"Filter by product.",children:"i"})]}),e.jsxs("select",{value:n.product_id,onChange:t=>i("product_id",t.target.value),className:"w-full rounded border px-3 py-2",children:[e.jsx("option",{value:"",children:"All"}),d?.products?.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm text-gray-600 flex items-center gap-1",children:["Vendor ",e.jsx(a,{text:"Filter by vendor who supplied purchases.",children:"i"})]}),e.jsxs("select",{value:n.vendor_id,onChange:t=>i("vendor_id",t.target.value),className:"w-full rounded border px-3 py-2",children:[e.jsx("option",{value:"",children:"All"}),d?.vendors?.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{disabled:y,className:"rounded bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700 disabled:opacity-50",children:"Apply Filters"}),e.jsx(P,{href:route("reports.inventoryAverage"),className:"rounded border px-4 py-2",children:"Reset"})]})]}),e.jsxs("div",{className:"rounded bg-white p-4 shadow overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left",children:[e.jsxs("th",{className:"px-2 py-2",children:["Product ",e.jsx(a,{text:"Product name and SKU.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Stock ",e.jsx(a,{text:"Current on-hand stock.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Available Qty ",e.jsx(a,{text:"On-hand minus lent-out quantity.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Old Qty ",e.jsx(a,{text:"Quantity from previous batches.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Old Unit Cost ",e.jsx(a,{text:"Estimated average cost for previous batches.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["New Qty ",e.jsx(a,{text:"Quantity in the most recent batch.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["New Unit Cost ",e.jsx(a,{text:"Unit cost of the most recent batch.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Weighted Avg Cost ",e.jsx(a,{text:"Weighted by purchase quantities across batches in range.",children:"i"})]}),e.jsxs("th",{className:"px-2 py-2 text-right",children:["Change ",e.jsx(a,{text:"New Unit Cost minus Old Unit Cost. Green=up, Red=down.",children:"i"})]}),e.jsx("th",{className:"px-2 py-2",children:"Last Purchase"})]})}),e.jsxs("tbody",{children:[l.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-2 py-6 text-center text-gray-500",children:"No data"})}),l.map(t=>{const s=C[t.id],r=s?.purchases?.points||u[t.id]?.points||[],o=s?.sales?.points||[],v=r.length?r[0].unit_cost:null,x=r.length>1?r.slice(1).reduce(($,F)=>$+Number(F.unit_cost||0),0)/(r.length-1):null,g=v!=null&&x&&x!==0?(v-x)/x*100:null,S=s?.metrics?.gross_margin??null,k=s?.metrics?.gross_margin_pct??null;return e.jsxs("tr",{className:"group relative border-t",children:[e.jsx("td",{className:"px-2 py-2",onMouseEnter:()=>b(t.id),children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:t.name}),t.sku&&e.jsxs("span",{className:"text-xs text-gray-500",children:["SKU: ",t.sku]})]}),(r.length>0||o.length>0)&&e.jsxs("div",{className:"absolute left-0 top-full z-30 hidden w-[420px] translate-y-2 rounded-md border bg-white p-3 shadow-lg group-hover:block",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Cost vs Selling"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Recent purchases & sales"})]}),N===t.id?e.jsx("div",{className:"flex h-[70px] w-full items-center justify-center text-xs text-gray-500",children:"Loading…"}):e.jsx(E,{purchases:r,sales:o,width:380,height:70}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"rounded bg-gray-50 p-2",children:[e.jsx("div",{className:"text-[11px] text-gray-500",children:"Latest Unit Cost"}),e.jsx("div",{className:"font-medium",children:e.jsx(h,{value:v})})]}),e.jsxs("div",{className:"rounded bg-gray-50 p-2",children:[e.jsx("div",{className:"text-[11px] text-gray-500",children:"Prev Avg Cost"}),e.jsx("div",{className:"font-medium",children:e.jsx(h,{value:x??0})})]}),e.jsxs("div",{className:"rounded bg-gray-50 p-2",children:[e.jsx("div",{className:"text-[11px] text-gray-500",children:"Change vs Prev Avg"}),e.jsx("div",{className:`font-medium ${g!=null&&g>0?"text-green-600":g!=null&&g<0?"text-red-600":""}`,children:g!=null?`${g.toFixed(2)}%`:"-"})]}),e.jsxs("div",{className:"rounded bg-gray-50 p-2",children:[e.jsx("div",{className:"text-[11px] text-gray-500",children:"Gross Margin"}),e.jsx("div",{className:"font-medium",children:S!=null?e.jsxs(e.Fragment,{children:[e.jsx(h,{value:S})," · ",k!=null?`${k}%`:""]}):"-"})]})]})]})]})}),e.jsx("td",{className:"px-2 py-2 text-right",children:t.stock}),e.jsx("td",{className:"px-2 py-2 text-right",children:t.available_qty}),e.jsx("td",{className:"px-2 py-2 text-right",children:t.old_qty}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx(h,{value:t.old_unit_cost})}),e.jsx("td",{className:"px-2 py-2 text-right",children:t.new_qty}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx(h,{value:t.new_unit_cost})}),e.jsx("td",{className:"px-2 py-2 text-right",children:e.jsx(h,{value:t.weighted_avg_unit_cost})}),e.jsx("td",{className:`${t.price_change>0?"text-green-600":t.price_change<0?"text-red-600":""} px-2 py-2 text-right`,children:e.jsx(h,{value:t.price_change})}),e.jsx("td",{className:"px-2 py-2",children:t.last_purchase_at||"-"})]},t.id)})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",c.from," - ",c.to," of ",c.total]}),e.jsx("div",{className:"flex items-center gap-2",children:c.links?.map((t,s)=>e.jsx(P,{href:t.url||"#",className:`px-3 py-1 rounded border ${t.active?"bg-indigo-600 text-white border-indigo-600":"bg-white text-gray-700"}`,dangerouslySetInnerHTML:{__html:t.label}},s))})]})]})]})]})}export{O as default};
